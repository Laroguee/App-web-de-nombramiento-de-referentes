<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Superintendencia de Regulaci√≥n Sanitaria - Gesti√≥n de Referentes de Farmacovigilancia</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    /* ... (Mismos estilos de siempre) ... */
    :root { --color-primary: #003366; --color-secondary: #0056b3; --bg-overlay: rgba(255, 255, 255, 0.98); }
    body { background-image: url('https://res.cloudinary.com/dowejnpvd/image/upload/v1769541332/fondo_srs_nhzesc.png'); background-size: cover; background-attachment: fixed; background-position: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; padding-bottom: 50px; }
    .main-container { background-color: var(--bg-overlay); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 40px; margin-bottom: 40px; padding: 40px; border-top: 6px solid var(--color-primary); }
    .header-logo { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
    .header-logo img { max-height: 90px; margin-bottom: 15px; }
    h2, h4 { color: var(--color-primary); font-weight: 700; }
    .section-title { border-left: 5px solid var(--color-secondary); padding-left: 15px; margin-top: 30px; margin-bottom: 20px; color: var(--color-primary); background-color: #f8f9fa; padding-top: 10px; padding-bottom: 10px; border-radius: 0 5px 5px 0; }
    .btn-primary { background-color: var(--color-primary); border-color: var(--color-primary); }
    .btn-primary:hover { background-color: var(--color-secondary); }
    .card-menu { cursor: pointer; transition: all 0.3s ease; border: 1px solid #e0e0e0; height: 100%; background: white; }
    .card-menu:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,50,100,0.15); border-color: var(--color-secondary); }
    .card-menu i { font-size: 3.5rem; margin-bottom: 15px; display: block; }
    .d-none { display: none !important; }
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 51, 102, 0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; backdrop-filter: blur(5px); }
    .checkbox-card { background-color: #f1f8ff; border: 1px solid #cce5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    
    /* Nuevo estilo para secci√≥n de documentos dentro de la tarjeta */
    .docs-section {
        background-color: #f8f9fa;
        border-top: 1px solid #eee;
        padding: 15px;
        margin-top: 15px;
        border-radius: 0 0 5px 5px;
    }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="d-none">
    <div class="spinner-border text-light" style="width: 4rem; height: 4rem;" role="status"></div>
    <h3 class="mt-4">Enviando solicitud...</h3>
    <p class="lead">Por favor, espere un momento.</p>
  </div>

  <!-- VENTANA MODAL DE √âXITO  -->
<div class="modal fade" id="modalExito" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center shadow-lg border-0">
      
      <!-- Cabecera Verde -->
      <div class="modal-header bg-success text-white justify-content-center border-0">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-check-circle-fill me-2"></i> Tr√°mite Registrado
        </h5>
      </div>

      <!-- Cuerpo del Mensaje -->
      <div class="modal-body p-4">
        <p class="lead mb-2" id="modalMensajePrincipal">Su solicitud ha sido procesada.</p>
        
        <!-- Aqu√≠ mostraremos el C√≥digo -->
        <div id="modalSeccionCodigo" class="d-none bg-light p-3 rounded border mt-3">
          <p class="small text-muted mb-1 text-uppercase fw-bold">Su n√∫mero de gesti√≥n es:</p>
          <h2 class="text-primary fw-bold mb-0" id="modalCodigoTexto">RFV-0000-0000</h2>
        </div>

        <p class="small text-muted mt-3 mb-0">
          <i class="bi bi-info-circle"></i> Guarde este n√∫mero. Se ha creado su expediente digital.
        </p>
        <p>Se ha enviado un correo de confirmaci√≥n,revise su bandeja de spam.</p>
      </div>

      <!-- Bot√≥n de Aceptar -->
      <div class="modal-footer justify-content-center border-0 pb-4">
        <button type="button" class="btn btn-success px-5 py-2 fw-bold" onclick="cerrarModalYReiniciar()">
          Aceptar y Finalizar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- MODAL DE ERROR (PROFESIONAL) -->
<div class="modal fade" id="modalError" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center shadow-lg border-0">
      
      <!-- Cabecera Roja -->
      <div class="modal-header bg-danger text-white justify-content-center border-0">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-exclamation-triangle-fill me-2"></i> Atenci√≥n
        </h5>
      </div>

      <!-- Cuerpo del Mensaje -->
      <div class="modal-body p-4">
        <p class="mb-0 fs-5" id="mensajeErrorTexto">Aqu√≠ va el error</p>
      </div>

      <!-- Bot√≥n -->
      <div class="modal-footer justify-content-center border-0 pb-4">
        <button type="button" class="btn btn-outline-danger px-4 fw-bold" data-bs-dismiss="modal">
          Entendido
        </button>
      </div>

    </div>
  </div>
</div>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10 main-container">
        
        <div class="header-logo">
          <img src="https://res.cloudinary.com/dowejnpvd/image/upload/v1769541342/logo_srs_azul_apiwn3.png" alt="Logo SRS">
          <h3>Sistema de Nombramiento de RFV</h3>
          <p class="text-muted">Plataforma Entrada Digital</p>
        </div>

        <!-- 1. MEN√ö PRINCIPAL -->
        <section id="menuPrincipal">
          <p class="text-center mb-5 lead fw-bold text-secondary">Seleccione el tipo de tr√°mite que desea realizar:</p>
          <div class="row g-4">
            <div class="col-md-4">
              <div class="card card-menu p-4 text-center" onclick="mostrarPantalla('nuevoIngreso')">
                <i class="bi bi-file-earmark-plus text-primary"></i>
                <h5 class="fw-bold">Nombramiento Referentes Farmacovigilancia</h5>
                <small class="text-muted">Nuevo Nombramiento o Cambio de Referente.</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-menu p-4 text-center" onclick="mostrarPantalla('subsanacion')">
                <i class="bi bi-pencil-square text-warning"></i>
                <h5 class="fw-bold">Subsanaci√≥n</h5>
                <small class="text-muted">Entrega de documentos corregidos.</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-menu p-4 text-center" onclick="mostrarPantalla('atestados')">
                <i class="bi bi-clipboard-check text-success"></i>
                <h5 class="fw-bold">Evaluaci√≥n Atestados</h5>
                <small class="text-muted">Revisi√≥n de atestados pendientes.</small>
              </div>
            </div>
          </div>
        </section>

        <!-- 2. PANTALLA: NUEVO INGRESO -->
        <section id="pantallaNuevoIngreso" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <h4 class="m-0"><i class="bi bi-file-earmark-plus"></i> Gesti√≥n de Referentes</h4>
            <button class="btn btn-secondary btn-sm" onclick="volverMenu()"><i class="bi bi-arrow-left"></i> Volver al Men√∫</button>
          </div>

          <form id="formNuevoIngreso" onsubmit="procesarEnvioVisual(event, 'Nuevo Ingreso')">
            <h5 class="section-title">1. Informaci√≥n de la Solicitud</h5>
            <div class="mb-4">
                <label class="form-label fw-bold text-primary">Tipo de Solicitud</label>
                <select class="form-select border-primary" id="ni_tipoSolicitud" name="ni_tipoSolicitud" onchange="logicNuevoIngreso()" required>
                   <option value="" selected disabled>Seleccione una opci√≥n...</option>
                   <option value="Nuevo Nombramiento">Nuevo Nombramiento</option>
                   <option value="Cambio de Referente">Cambio de Referente</option>
                </select>
            </div>

            <div id="ni_restodelFormulario" class="d-none">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Fecha de Ingreso de Solicitud</label>
                    <input type="date" class="form-control" id="ni_fecha" name="ni_fecha" required data-bs-toggle="tooltip" data-bs-placement="top" 
       title="Seleccione la fecha en que est√° realizando este tr√°mite.">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Tipo de Establecimiento</label>
                    <select class="form-select" id="ni_tipoEstablecimiento" name="ni_tipoEstablecimiento" onchange="configurarReferentesNI()" required data-bs-toggle="tooltip" title="Seleccione el rubro seg√∫n su licencia de funcionamiento.">
                      <option value="" selected disabled>Seleccione...</option>
                      <option value="TRS_Nacional">Titular Registro Sanitario (Nacional)</option>
                      <option value="TRS_Extranjero">Titular Registro Sanitario (Internacional)</option>
                      <option value="Institucional">Institucional (ISSS, MINSAL, ISBM...)</option>
                      <option value="Botiquin">Botiqu√≠n Hospitalario</option>
                      <option value="Drogueria">Droguer√≠a</option>
                      <option value="Laboratorio">Laboratorio</option>
                      <option value="Farmacia">Farmacia</option>
                      <option value="Prestador">Prestador de Servicios de Salud</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">¬øEs Conglomerado?</label>
                    <select class="form-select" id="ni_conglomerado" name="ni_conglomerado" onchange="toggleConglomerado('ni')"data-bs-toggle="tooltip" title="Indique si hay m√°s de una establecimiento dentro del formulario.">
                      <option value="No">No</option>
                      <option value="Si">S√≠</option>
                    </select>
                  </div>
                  <div class="col-md-6 d-none" id="div_ni_numEstablecimientos">
                    <label class="form-label fw-bold text-danger">N√∫mero de Establecimientos</label>
                    <input type="number" class="form-control" id="ni_cantidadEstablecimientos" name="ni_cantidadEstablecimientos" min="1" placeholder="Ingrese cantidad">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Nombre del Solicitante</label>
                    <input type="text" class="form-control" id="ni_nombreSolicitante" name="ni_nombreSolicitante" maxlength="100" required
                    data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Escriba el nombre completo tal como aparece en el DUI/Carnet.">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Cargo del Solicitante</label>
                    <input type="text" class="form-control" id="ni_cargoSolicitante" name="ni_cargoSolicitante" maxlength="100" required>
                  </div>
                  <div class="col-md-12">
  <label class="form-label fw-bold text-success">Correo para Notificaciones</label>
  <input type="email" class="form-control" id="ni_email" name="ni_email" required placeholder="ejemplo@institucion.com"
  data-bs-toggle="tooltip" title="Aseg√∫rese de que sea un correo v√°lido, aqu√≠ recibir√° la confirmaci√≥n.">
  <small class="text-muted">A este correo se enviar√° el n√∫mero de gesti√≥n generado.</small>
</div>
                </div>

                <div id="ni_selectorCambio" class="checkbox-card mt-4 d-none">
                    <p class="mb-2 fw-bold text-primary"><i class="bi bi-check2-square"></i> Seleccione el/los referentes que desea cambiar:</p>
                    <div id="ni_checkboxesContainer"></div>
                 </div>

                <!-- SECCI√ìN REFERENTES (Aqu√≠ se generar√°n las tarjetas con los inputs de archivos dentro) -->
                <div id="ni_seccionReferentes" class="mt-4"></div>

                <!-- DOCUMENTACI√ìN GLOBAL -->
                <h5 class="section-title">3. Documentaci√≥n General</h5>
                <div class="alert alert-light border small text-muted">
                    <i class="bi bi-info-circle"></i> Documento √∫nico por solicitud. Formato PDF.
                </div>
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label fw-bold">Formulario de Nombramiento (PDF)</label>
                    <input type="file" class="form-control" accept=".pdf" required id="file_ni_nombramiento" name="file_ni_nombramiento"
                    data-bs-toggle="tooltip" title="Formulario de nombramiento de referentes de farmacovigilancia y sus modificaciones">
                  </div>
                </div>

                <div class="mt-5 text-end border-top pt-3">
                  <button type="button" class="btn btn-outline-danger me-2" onclick="volverMenu()">Cancelar</button>
                  <button type="submit" class="btn btn-primary btn-lg px-5">
                     Enviar Solicitud <i class="bi bi-send-fill ms-2"></i>
                  </button>
                </div>
            </div>
          </form>
        </section>

        <!-- 3. PANTALLA: SUBSANACI√ìN -->
        <section id="pantallaSubsanacion" class="d-none">
            <!-- (Contenido igual, resumido para brevedad) -->
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                <h4 class="m-0"><i class="bi bi-pencil-square"></i> Subsanaci√≥n</h4>
                <button class="btn btn-secondary btn-sm" onclick="volverMenu()"><i class="bi bi-arrow-left"></i> Volver al Men√∫</button>
            </div>
            <form id="formSubsanacion" onsubmit="procesarEnvioVisual(event, 'Subsanacion')">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">No. Solicitud  </label>
                        <input type="text" class="form-control" id="sub_correlativo" name="sub_correlativo" required
                        data-bs-toggle="tooltip" title="correlativo de solicitud que se le brindo al realizar el nombramiento de referentes (Ej: RFV-2026-0030)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha</label>
                        <input type="date" class="form-control" id="sub_fecha" name="sub_fecha" required
                        data-bs-toggle="tooltip" data-bs-placement="top" 
       title="Seleccione la fecha en que est√° realizando este tr√°mite.">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Tipo Establecimiento</label>
                        <select class="form-select" id="sub_tipoEstablecimiento" name="sub_tipoEstablecimiento" required
                        data-bs-toggle="tooltip" title="Seleccione el rubro seg√∫n su licencia de funcionamiento.">
                            <option value="" selected disabled>Seleccione...</option>
                      <option value="TRS_Nacional">Titular Registro Sanitario (Nacional)</option>
                      <option value="TRS_Extranjero">Titular Registro Sanitario (Internacional)</option>
                      <option value="Institucional">Institucional (ISSS, MINSAL, ISBM...)</option>
                      <option value="Botiquin">Botiqu√≠n Hospitalario</option>
                      <option value="Drogueria">Droguer√≠a</option>
                      <option value="Laboratorio">Laboratorio</option>
                      <option value="Farmacia">Farmacia</option>
                      <option value="Prestador">Prestador de Servicios de Salud</option>
                            
                        </select>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Nombre Solicitante</label>
                        <input type="text" class="form-control" id="sub_nombreSolicitante" name="sub_nombreSolicitante" required
                        data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Escriba el nombre completo tal como aparece en el DUI/Carnet.">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Cargo</label>
                        <input type="text" class="form-control" id="sub_cargoSolicitante" name="sub_cargoSolicitante" required>
                    </div>
                    <div class="col-12">
  <label class="form-label fw-bold text-success">Correo para Notificaciones</label>
  <input type="email" class="form-control" id="sub_email" name="sub_email" required placeholder="ejemplo@institucion.com"
  data-bs-toggle="tooltip" title="Aseg√∫rese de que sea un correo v√°lido, aqu√≠ recibir√° la confirmaci√≥n.">
</div>
                    <div class="col-12 mt-3">
                        <label class="form-label fw-bold">Adjuntar Documentos (PDF)</label>
                        <input type="file" class="form-control" id="file_sub_documentos" name="file_sub_documentos" accept=".pdf" required>
                    </div>
                </div>
                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-warning text-white">Enviar Subsanaci√≥n</button>
                </div>
            </form>
        </section>

        <!-- 4. PANTALLA: ATESTADOS -->
        <section id="pantallaAtestados" class="d-none">
           <!-- (Contenido igual, resumido para brevedad) -->
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                <h4 class="m-0"><i class="bi bi-clipboard-check"></i> Evaluaci√≥n Atestados</h4>
                <button class="btn btn-secondary btn-sm" onclick="volverMenu()"><i class="bi bi-arrow-left"></i> Volver al Men√∫</button>
            </div>
            <form id="formAtestados" onsubmit="procesarEnvioVisual(event, 'Atestados')">
                <div class="row g-3">
                    <div class="col-md-4"><label class="fw-bold">N. Solicitud</label><input type="text" class="form-control" name="at_correlativo" required
                    data-bs-toggle="tooltip" title="correlativo de solicitud que se le brindo al realizar el nombramiento de referentes (Ej: RFV-2026-0030)"></div>

                  <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha</label>
                        <input type="date" class="form-control" id="at_fecha" name="at_fecha" required
                        data-bs-toggle="tooltip" data-bs-placement="top" 
       title="Seleccione la fecha en que est√° realizando este tr√°mite.">
                    </div>
                    
                    <div class="col-6"><label class="fw-bold">Tipo Referente</label><select class="form-select" name="at_tipoReferente"><option>Titular</option><option>Suplente</option><option>ESAVI</option><option>Local</option></select></div>
                    <div class="col-6"><label class="fw-bold">Correlativo Ref.</label><input type="text" class="form-control" name="at_correlativoReferente" required
                    data-bs-toggle="tooltip" title="Correlativo de nombramiento de referente (Ej: RFT-2026-000, RFS-2026-000...)"></div>
                  <div class="col-12 mt-3">
  <label class="form-label fw-bold text-success">Correo para Notificaciones</label>
  <!-- OJO: Cambiamos sub_email por at_email -->
  <input type="email" class="form-control" id="at_email" name="at_email" required data-bs-toggle="tooltip" title="Aseg√∫rese de que sea un correo v√°lido, aqu√≠ recibir√° la confirmaci√≥n." placeholder="ejemplo@institucion.com">
</div>
                    <div class="col-12 mt-3"><label class="fw-bold">Atestados (PDF)</label><input type="file" class="form-control" name="file_at_atestados" accept=".pdf" required></div>
                </div>
                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-success">Enviar Evaluaci√≥n</button>
                </div>
            </form>
        </section>

      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- NAVEGACI√ìN ---
    function mostrarPantalla(pantalla) {
      document.getElementById('menuPrincipal').classList.add('d-none');
      document.getElementById('pantallaNuevoIngreso').classList.add('d-none');
      document.getElementById('pantallaSubsanacion').classList.add('d-none');
      document.getElementById('pantallaAtestados').classList.add('d-none');

      if(pantalla === 'nuevoIngreso') document.getElementById('pantallaNuevoIngreso').classList.remove('d-none');
      if(pantalla === 'subsanacion') document.getElementById('pantallaSubsanacion').classList.remove('d-none');
      if(pantalla === 'atestados') document.getElementById('pantallaAtestados').classList.remove('d-none');
      window.scrollTo(0,0);
    }

    function volverMenu() {
      document.getElementById('ni_tipoSolicitud').value = "";
      if(document.getElementById('ni_restodelFormulario')) {
         document.getElementById('ni_restodelFormulario').classList.add('d-none');
      }
      mostrarPantalla('menu');
      document.getElementById('menuPrincipal').classList.remove('d-none');
    }

    function toggleConglomerado(prefix) {
      const val = document.getElementById(prefix + '_conglomerado').value;
      const divNum = document.getElementById('div_' + prefix + '_numEstablecimientos');
      if(val === 'Si') {
        divNum.classList.remove('d-none');
        document.getElementById(prefix + '_cantidadEstablecimientos').required = true;
      } else {
        divNum.classList.add('d-none');
        document.getElementById(prefix + '_cantidadEstablecimientos').required = false;
        document.getElementById(prefix + '_cantidadEstablecimientos').value = '';
      }
    }

    // --- NUEVA FUNCI√ìN GENERADORA: AHORA INCLUYE LOS ARCHIVOS ---
    // --- GENERADOR DE TARJETAS (ACTUALIZADO PARA TRS EXTRANJERO) ---
    function generarHTMLReferente(titulo, rolKey, requerido, prefix, config = {}) {
      // Configuraci√≥n por defecto si no se especifica
      const mostrarJV = config.mostrarJV !== undefined ? config.mostrarJV : true;
      const mostrarDocsStandard = config.mostrarDocsStandard !== undefined ? config.mostrarDocsStandard : true; // Carnet y Anualidad
      const mostrarDocRespaldo = config.mostrarDocRespaldo !== undefined ? config.mostrarDocRespaldo : false; // Doc nuevo

      const reqAttr = requerido ? 'required' : '';
      const badge = requerido ? '<span class="text-danger">*</span>' : '<span class="badge bg-secondary">Opcional</span>';
      
      // HTML para el campo JV (Condicional)
      const htmlJV = mostrarJV ? `
            <div class="col-md-4">
              <label class="form-label small text-muted fw-bold">No. Junta Vigilancia</label>
              <input type="text" class="form-control input-referente" 
                     id="${prefix}_jv_${rolKey}" 
                     name="${prefix}_jv_${rolKey}" 
                     ${reqAttr} maxlength="20"
                     data-bs-toggle="tooltip" title="Ingrese el n√∫mero de inscripci√≥n.">
            </div>` : '';

      // HTML para Carnet y Anualidad (Condicional)
      const htmlDocsStandard = mostrarDocsStandard ? `
                <div class="col-md-6">
                   <small class="text-muted d-block">Anualidad (PDF) <span class="text-danger">*</span></small>
                   <input type="file" class="form-control form-control-sm input-referente" accept=".pdf" 
                          name="${prefix}_file_${rolKey}_anualidad" ${reqAttr}
                          data-bs-toggle="tooltip" title="Comprobante de pago de anualidad vigente.">
                </div>
                <div class="col-md-6">
                   <small class="text-muted d-block">Carnet CSSP (PDF) <span class="text-danger">*</span></small>
                   <input type="file" class="form-control form-control-sm input-referente" accept=".pdf" 
                          name="${prefix}_file_${rolKey}_carnet" ${reqAttr}
                          data-bs-toggle="tooltip" title="Imagen escaneada del carnet.">
                </div>` : '';

      // HTML para Documento Respaldo (Nuevo para Extranjeros)
      const htmlDocRespaldo = mostrarDocRespaldo ? `
                <div class="col-md-12">
                   <small class="text-muted d-block fw-bold text-primary">Documento de Respaldo Profesional (PDF) <span class="text-danger">*</span></small>
                   <input type="file" class="form-control form-control-sm input-referente" accept=".pdf" 
                          name="${prefix}_file_${rolKey}_respaldo" ${reqAttr}
                          data-bs-toggle="tooltip" title="Documento que respalde el ejercicio profesional (T√≠tulo, Licencia, etc).">
                </div>` : '';

      return `
      <div class="card mb-3 shadow-sm card-referente" id="card_${prefix}_${rolKey}" data-rol="${rolKey}" data-titulo="${titulo}">
        <div class="card-body">
          <h6 class="card-title text-primary fw-bold mb-3 border-bottom pb-2">${titulo} ${badge}</h6>
          
          <div class="row g-3">
            <div class="${mostrarJV ? 'col-md-8' : 'col-md-12'}">
              <label class="form-label small text-muted fw-bold">Nombre Completo</label>
              <input type="text" class="form-control input-referente" 
                     id="${prefix}_nombre_${rolKey}" 
                     name="${prefix}_nombre_${rolKey}" 
                     ${reqAttr} maxlength="100"
                     data-bs-toggle="tooltip" title="Escriba el nombre completo.">
            </div>
            ${htmlJV} 
          </div>

          <div class="docs-section">
             <label class="form-label small fw-bold text-dark mb-2">Documentaci√≥n de Soporte (${titulo})</label>
             <div class="row g-2">
                ${htmlDocRespaldo}
                
                ${htmlDocsStandard}

                <div class="col-md-6">
                   <small class="text-muted d-block">Atestados (PDF)</small>
                   <input type="file" class="form-control form-control-sm input-referente" accept=".pdf" 
                          name="${prefix}_file_${rolKey}_atestados"
                          data-bs-toggle="tooltip" title="Diploma o constancia de capacitaci√≥n.">
                </div>
                <div class="col-md-6">
                   <small class="text-muted d-block">Carta Compromiso (PDF)</small>
                   <input type="file" class="form-control form-control-sm input-referente" accept=".pdf" 
                          name="${prefix}_file_${rolKey}_carta"
                          data-bs-toggle="tooltip" title="Solo si no posee atestados."> 
                </div>
             </div>
             <div class="form-text small mt-2 fst-italic text-secondary">
                <i class="bi bi-exclamation-circle"></i> Debe adjuntar <strong>Atestados</strong> O <strong>Carta de Compromiso</strong>.
             </div>
          </div>

        </div>
      </div>`;
    }

    // --- CONFIGURACI√ìN DE REFERENTES ---
  function configurarReferentesNI() {
      const prefix = 'ni';
      const tipo = document.getElementById(prefix + '_tipoEstablecimiento').value;
      const contenedor = document.getElementById(prefix + '_seccionReferentes');
      
      if(!tipo) return;

      contenedor.innerHTML = ''; 
      let html = '<h5 class="section-title">2. Datos de Referentes y Documentos</h5>';

      // --- CASO TRS EXTRANJERO ---
      if (tipo === 'TRS_Extranjero') {
          // Titular Internacional: Sin JV, Sin Carnet/Anualidad, CON Respaldo
          html += generarHTMLReferente("Referente Titular Propietario de Farmacoviglancia (Internacional)", "titular", true, prefix, {
              mostrarJV: false,
              mostrarDocsStandard: false,
              mostrarDocRespaldo: true
          });
          // Referente Local (Normal)
          html += generarHTMLReferente("Referente Local de Farmacovigilancia", "local", true, prefix);
      } 
      
      // --- CASO FARMACIA ---
      else if (tipo === 'Farmacia') {
          // Solo Titular, SIN Suplente
          html += generarHTMLReferente("Referente Titular Propietario de Farmacovigilancia", "titular", true, prefix);
      }

      // --- RESTO DE CASOS (Prestador, Institucional, etc.) ---
      else {
          let labelTitular = "Referente Titular Propietario de Farmacovigilancia";
          if(tipo.includes("Institucional")) labelTitular = "Referente Titular Institucional de Farmacovigilancia";
          html += generarHTMLReferente(labelTitular, "titular", true, prefix);

          if (tipo !== 'Prestador') { 
            let labelSuplente = "Referente Suplente de Farmacovigilancia";
            if(tipo.includes("Institucional")) labelSuplente = "Referente Suplente Institucional de Farmacovigilancia";
            html += generarHTMLReferente(labelSuplente, "suplente", true, prefix);
          }
      }

      // --- ESAVI ---
      if (tipo === 'Institucional' || tipo === 'Botiquin') {
        html += generarHTMLReferente("Referente ESAVI de Farmacovigilancia", "esavi", true, prefix);
      }

      // --- PRESTADOR (Check Vacunas) ---
      if (tipo === 'Prestador') {
         html += `
         <div class="form-check my-3 p-3 bg-white border rounded shadow-sm" id="div_check_vacunas">
            <input class="form-check-input" type="checkbox" id="${prefix}_incluyeVacunas" name="${prefix}_incluyeVacunas" onchange="toggleEsaviPrestador('${prefix}')">
            <label class="form-check-label fw-bold" for="${prefix}_incluyeVacunas">
               ¬øIncluye manejo de vacunas?
            </label>
         </div>
         <div id="container_${prefix}_esavi" class="d-none">
            ${generarHTMLReferente("Referente ESAVI de Farmacovigilancia", "esavi", true, prefix)}
         </div>
         `;
      }

      contenedor.innerHTML = html;
      
      // IMPORTANTE: Llamar a las funciones de l√≥gica y UI
      logicNuevoIngreso(); // Re-calcula si debe mostrar checkboxes o tarjetas completas
      activarTooltips();   // Activa los mensajes de ayuda
    }

    // --- VISIBILIDAD (Nuevo vs Cambio) ---
    function logicNuevoIngreso() {
        const tipoSolicitud = document.getElementById('ni_tipoSolicitud').value;
        const contenidoFormulario = document.getElementById('ni_restodelFormulario');
        const selectorCambio = document.getElementById('ni_selectorCambio');
        const containerCheckboxes = document.getElementById('ni_checkboxesContainer');
        const cards = document.querySelectorAll('#ni_seccionReferentes .card-referente');
        const checkVacunas = document.getElementById('div_check_vacunas'); 

        if(tipoSolicitud && tipoSolicitud !== "") {
            contenidoFormulario.classList.remove('d-none');
        } else {
            contenidoFormulario.classList.add('d-none');
            return;
        }

        if(cards.length === 0) return;

        if(tipoSolicitud === 'Nuevo Nombramiento') {
            selectorCambio.classList.add('d-none');
            cards.forEach(c => {
                c.classList.remove('d-none');
                // Si la tarjeta es obligatoria (ej: Titular), activamos inputs
                // Si es opcional (Suplente Farmacia), dejamos activos pero no required
                // La funci√≥n generarHTML ya puso 'required' est√°ticamente si correspond√≠a
                enableInputs(c, true); 
            });
            if(checkVacunas) checkVacunas.classList.remove('d-none');
        } 
        else if (tipoSolicitud === 'Cambio de Referente') {
            selectorCambio.classList.remove('d-none');
            if(checkVacunas) checkVacunas.classList.add('d-none'); 

            let chkHtml = '';
            cards.forEach(c => {
                const rol = c.dataset.rol;
                const titulo = c.dataset.titulo.replace('*','').replace('Opcional',''); 
                chkHtml += `
                    <div class="form-check form-check-inline me-3">
                        <input class="form-check-input" type="checkbox" value="${c.id}" onchange="filtrarInputsNI()">
                        <label class="form-check-label">${titulo}</label>
                    </div>
                `;
            });
            containerCheckboxes.innerHTML = chkHtml;
            filtrarInputsNI();
        }
    }

    function filtrarInputsNI() {
        const checkboxes = document.querySelectorAll('#ni_checkboxesContainer input');
        document.querySelectorAll('#ni_seccionReferentes .card-referente').forEach(c => {
            c.classList.add('d-none');
            enableInputs(c, false); // Deshabilita TODO (texto y archivos)
        });

        checkboxes.forEach(chk => {
            if(chk.checked) {
                const card = document.getElementById(chk.value);
                if(card) {
                    card.classList.remove('d-none');
                    if(chk.value.includes('esavi') && document.getElementById('container_ni_esavi')){
                        document.getElementById('container_ni_esavi').classList.remove('d-none');
                    }
                    enableInputs(card, true); // Habilita texto y archivos
                }
            }
        });
    }

    function enableInputs(cardElement, enable) {
        const inputs = cardElement.querySelectorAll('input, select'); // Incluimos selects si hubiera
        const tipoSolicitud = document.getElementById('ni_tipoSolicitud').value;

        inputs.forEach(inp => {
            if (enable) {
                inp.disabled = false;
                
                // L√ìGICA PARA MODO "CAMBIO DE REFERENTE"
                if (tipoSolicitud === 'Cambio de Referente') {
                    // Por defecto, si activo el checkbox, el campo se vuelve obligatorio...
                    inp.required = true;

                    // ... excepcion para los que tienen validaci√≥n especial:
                    // 1. Carta: Siempre es opcional (depende de atestados)
                    // 2. Atestados: Lo dejamos opcional en HTML para que la funci√≥n validarAtestadosOCarta decida
                    if (inp.name.includes('carta') || inp.name.includes('atestados')) {
                        inp.required = false; 
                    }
                    
                    // NOTA: El campo 'respaldo' (Extranjero) NO cae en la excepci√≥n, 
                    // as√≠ que se volver√° 'required = true' autom√°ticamente. ¬°Correcto!
                }
            } else {
                inp.disabled = true;
                // Al deshabilitar, quitamos el required para que no bloquee el env√≠o
                inp.required = false; 
            }
        });
    }

    function toggleEsaviPrestador(prefix) {
      const chk = document.getElementById(prefix + '_incluyeVacunas');
      const div = document.getElementById('container_' + prefix + '_esavi');
      if(!div) return;
      const inputs = div.querySelectorAll('input');
      
      if(chk.checked) {
        div.classList.remove('d-none');
        inputs.forEach(i => { i.disabled = false; if(!i.name.includes('carta')) i.required = true; });
      } else {
        div.classList.add('d-none');
        inputs.forEach(i => { i.disabled = true; i.required = false; i.value = ''; });
      }
    }

    // --- VALIDACI√ìN DE MEN√öS DESPLEGABLES ---
    function validarSelects(form) {
        // Buscamos todos los select que tengan el atributo 'required'
        const selects = form.querySelectorAll('select[required]');
        
        for (let select of selects) {
            // Verificamos si el elemento es visible (para no validar selects de secciones ocultas)
            // offsetParent es null si el elemento (o su padre) tiene display: none
            if (select.offsetParent !== null) {
                
                if (!select.value || select.value === "") {
                    // Intentamos obtener el nombre del campo desde el label anterior
                    let nombreCampo = "un campo de selecci√≥n";
                    const label = select.previousElementSibling; 
                    if (label && label.tagName === 'LABEL') {
                        nombreCampo = label.innerText;
                    }

                    alert(`‚ö†Ô∏è CAMPO INCOMPLETO\n\nPor favor, seleccione una opci√≥n v√°lida en: "${nombreCampo}"`);
                    
                    select.classList.add('is-invalid'); // Pone el borde rojo
                    select.focus(); // Lleva al usuario al campo vac√≠o
                    return false; // Detiene el env√≠o
                } else {
                    select.classList.remove('is-invalid');
                }
            }
        }
        return true; // Todo correcto
    }

    // --- NUEVA VALIDACI√ìN DE ARCHIVOS EN FRONTEND ---
  
function validarArchivosPDF(form) {
        const inputsFile = form.querySelectorAll('input[type="file"]');
        
        // LIMITES
        const LIMITE_INDIVIDUAL_MB = 4; // Ning√∫n archivo puede pesar m√°s de esto
        const LIMITE_TOTAL_MB = 20;     // La suma de todos no puede pasar de esto
        
        const BYTES_INDIVIDUAL = LIMITE_INDIVIDUAL_MB * 1024 * 1024;
        const BYTES_TOTAL = LIMITE_TOTAL_MB * 1024 * 1024;

        let pesoAcumulado = 0; // Aqu√≠ iremos sumando

        for (let input of inputsFile) {
            if (input.files.length > 0) {
                for (let file of input.files) {
                    
                    // 1. VALIDAR FORMATO (PDF)
                    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
                        mostrarError(`‚ùå <strong>ERROR DE FORMATO</strong><br><br>El archivo "<em>${file.name}</em>" no es un PDF.<br>Solo se permiten archivos .pdf`);
                        input.value = ''; 
                        input.classList.add('is-invalid'); 
                        return false; 
                    } 
                    
                    // 2. VALIDAR TAMA√ëO INDIVIDUAL (4 MB)
                    if (file.size > BYTES_INDIVIDUAL) {
                        let pesoArchivo = (file.size / 1024 / 1024).toFixed(2);
                        mostrarError(`‚ö†Ô∏è <strong>ARCHIVO MUY PESADO</strong><br><br>El archivo "<em>${file.name}</em>" pesa <strong>${pesoArchivo} MB</strong>.<br>El m√°ximo individual es <strong>${LIMITE_INDIVIDUAL_MB} MB</strong>.<br><br>Por favor, compr√≠malo.`);
                        input.value = ''; 
                        input.classList.add('is-invalid'); 
                        return false;
                    }

                    // Si pasa, sumamos al total
                    pesoAcumulado += file.size;
                    input.classList.remove('is-invalid');
                }
            }
        }

        // 3. VALIDAR TAMA√ëO TOTAL (LA BOLSA)
        if (pesoAcumulado > BYTES_TOTAL) {
            let totalMB = (pesoAcumulado / 1024 / 1024).toFixed(2);
            mostrarError(`‚ö†Ô∏è <strong>EXCESO DE TAMA√ëO TOTAL</strong><br><br>
            Est√° intentando enviar <strong>${totalMB} MB</strong> en total entre todos los documentos.<br>
            El sistema permite un m√°ximo de <strong>${LIMITE_TOTAL_MB} MB</strong> por solicitud para garantizar el env√≠o.<br><br>
            <strong>Soluci√≥n:</strong> Utilice herramientas como "iLovePDF" o "SmallPDF" para comprimir sus archivos antes de subirlos.`);
            return false;
        }

        return true; 
    }

    // --- NUEVA VALIDACI√ìN: CAMPOS DE TEXTO VAC√çOS ---
    function validarCamposTexto(form) {
        // Buscamos inputs de texto obligatorios
        const inputs = form.querySelectorAll('input[type="text"][required]');
        
        for (let input of inputs) {
            // Verificamos si el elemento es visible (offsetParent !== null)
            // Esto es vital para no validar campos de formularios ocultos (ej: si estoy en Nuevo, no valido Subsanaci√≥n)
            if (input.offsetParent !== null) {
                
                if (!input.value || input.value.trim() === "") {
                    // Intentamos obtener el nombre del campo desde el label anterior
                    let nombreCampo = "un campo obligatorio";
                    const label = input.previousElementSibling; 
                    if (label && label.tagName === 'LABEL') {
                        nombreCampo = label.innerText;
                    }
                    
                    // Buscamos el t√≠tulo de la tarjeta para ser m√°s espec√≠ficos
                    let contexto = "";
                    const tarjeta = input.closest('.card-referente');
                    if (tarjeta) {
                        const titulo = tarjeta.querySelector('.card-title');
                        if (titulo) contexto = `En: <strong>${titulo.innerText}</strong><br>`;
                    }

                    mostrarError(`‚ö†Ô∏è <strong>CAMPO VAC√çO</strong><br><br>${contexto}Por favor, complete el campo:<br>üëâ <strong>"${nombreCampo}"</strong>`);
                    
                    input.classList.add('is-invalid');
                    setTimeout(() => input.focus(), 500); 
                    return false; // Detiene el env√≠o
                } else {
                    input.classList.remove('is-invalid');
                }
            }
        }
        return true; // Todo correcto
    }
    // --- VALIDACI√ìN L√ìGICA: ATESTADOS O CARTA ---
    
function validarAtestadosOCarta(form) {
        if (form.id !== 'formNuevoIngreso') return true;
        const cards = form.querySelectorAll('.card-referente:not(.d-none)');

        for (let card of cards) {
            const inputNombre = card.querySelector('input[name*="_nombre_"]');
            if (!inputNombre || inputNombre.value.trim() === "") continue;

            const inputAtestados = card.querySelector('input[name*="_atestados"]');
            const inputCarta = card.querySelector('input[name*="_carta"]');
            const tituloReferente = card.querySelector('.card-title').innerText;

            if (inputAtestados && !inputAtestados.disabled) {
                const tieneAtestados = inputAtestados.files.length > 0;
                const tieneCarta = inputCarta.files.length > 0;

                if (!tieneAtestados && !tieneCarta) {
                    // --- AQU√ç EL CAMBIO ---
                    mostrarError(`‚ö†Ô∏è <strong>FALTA DOCUMENTACI√ìN</strong><br>Referente: ${tituloReferente}<br><br>Debe adjuntar obligatoriamente:<br>üëâ Atestados de Farmacovigilancia<br>O BIEN<br>üëâ Carta de Compromiso.`);
                    
                    inputAtestados.classList.add('is-invalid');
                    inputCarta.classList.add('is-invalid');
                    return false; 
                } else {
                    inputAtestados.classList.remove('is-invalid');
                    inputCarta.classList.remove('is-invalid');
                }
            }
        }
        return true; 
    }
// FUNCI√ìN PARA MOSTRAR ERRORES BONITOS
    function mostrarError(mensaje) {
        const modalEl = document.getElementById('modalError');
        const textoEl = document.getElementById('mensajeErrorTexto');
        
        textoEl.innerHTML = mensaje; // Usamos innerHTML para permitir saltos de linea <br>
        
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    // 1. FUNCI√ìN PARA ABRIR LA VENTANA BONITA
    function mostrarModalExito(tipo, codigo) {
      const modalElement = document.getElementById('modalExito');
      const mensajePrincipal = document.getElementById('modalMensajePrincipal');
      const seccionCodigo = document.getElementById('modalSeccionCodigo');
      const codigoTexto = document.getElementById('modalCodigoTexto');
      
      // Personalizar mensaje
      if (tipo === 'Nuevo Ingreso' && codigo) {
        mensajePrincipal.innerText = "La solicitud se registr√≥ correctamente.";
        seccionCodigo.classList.remove('d-none'); // Mostrar caja del c√≥digo
        codigoTexto.innerText = codigo;
      } else {
        // Para Subsanaciones/Atestados, el c√≥digo trae el mensaje completo
        mensajePrincipal.innerText = codigo; 
        seccionCodigo.classList.add('d-none'); // Ocultar caja del c√≥digo
      }

      // Mostrar el modal usando Bootstrap
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }

    // 2. FUNCI√ìN PARA EL BOT√ìN "ACEPTAR"
    function cerrarModalYReiniciar() {
      // Ocultar modal
      const modalElement = document.getElementById('modalExito');
      const modal = bootstrap.Modal.getInstance(modalElement);
      modal.hide();
      
      // Volver al men√∫ principal
      volverMenu();
    }

    // --- FUNCI√ìN DE ENV√çO ACTUALIZADA ---
    function procesarEnvioVisual(e, tipoFormulario) {
      e.preventDefault();
      const form = e.target;

      // --- ORDEN DE VALIDACIONES ---
      
      // 1. Validar Selects (Men√∫s desplegables)
      if (!validarSelects(form)) return;

      // 2. Validar Campos de Texto (Nombres, Cargos, JV) <--- NUEVO
      if (!validarCamposTexto(form)) return;
      
      // 3. Validar Archivos (Que sean PDF y formato correcto)
      if (!validarArchivosPDF(form)) return;

      // 4. Validar L√≥gica Atestados vs Carta
      if (typeof validarAtestadosOCarta === "function") {
         if (!validarAtestadosOCarta(form)) return;
      }

      // --- SI PASA TODO, PROCEDE AL ENV√çO ---
      const botonSubmit = form.querySelector('button[type="submit"]');
      const textoOriginal = botonSubmit.innerHTML; 
      const overlay = document.getElementById('loadingOverlay');
      const tituloCarga = overlay.querySelector('h3');
      
      tituloCarga.innerText = "Validando documentos y creando expediente...";
      overlay.classList.remove('d-none');
      
      botonSubmit.disabled = true;
      botonSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

      google.script.run
        .withSuccessHandler(function(response) {
          botonSubmit.disabled = false;
          botonSubmit.innerHTML = textoOriginal;

          if (response.startsWith("Exito")) {
             const partes = response.split('|');
             const infoExtra = partes[1]; 

             form.reset();
             if(document.getElementById('ni_restodelFormulario')) {
                document.getElementById('ni_restodelFormulario').classList.add('d-none');
             }

             mostrarModalExito(tipoFormulario, infoExtra);
             overlay.classList.add('d-none');
             
          } else {
             overlay.classList.add('d-none');
             mostrarError("‚ö†Ô∏è <strong>ERROR DE SERVIDOR</strong><br>" + response);
          }
        })
        .withFailureHandler(function(error) {
          overlay.classList.add('d-none');
          botonSubmit.disabled = false;
          botonSubmit.innerHTML = textoOriginal;
          mostrarError("‚ùå <strong>ERROR DEL SISTEMA</strong><br>" + (error.message || String(error)));
        })
        .procesarFormulario(form);
    }

    // --- FUNCI√ìN PARA ACTIVAR LOS MENSAJES (TOOLTIPS) ---
    function activarTooltips() {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    // Activar al cargar la p√°gina por primera vez
    window.addEventListener('load', activarTooltips);
  </script>
</body>
</html>