// --- CONFIGURACIÓN DE IDs ---
const ID_FOLDER_GESTION     = "1duuPt6vgjtJsy1HIh062vD1YdqJ3p6Lm";
const ID_FOLDER_SUBSANACION = "1nrhlmxEA9fwFfni6yyxgqXEmsi_uVeai";
const ID_FOLDER_ATESTADOS   = "1592GAYi7AruWEGHFwhYGEpGvnwr4a_XQ";
const ID_FOLDER_DICTAMENES  = "1Isb_1gtt1_uNA0hDA2m4j2lJ0ijQGfdv";

const ID_SHEET = "1ESor7hY9VI-oxkXofm-tGAffjWN4iQ1krInICrFeLWA";

const MAPA_DICTAMENES = {
  "Farmacia": "dictamen_1", "Prestador": "dictamen_1",

  "Drogueria": "dictamen_2", "Laboratorio": "dictamen_2", "TRS_Nacional": "dictamen_2",

  "TRS_Extranjero": "dictamen_3",

  "Botiquin": "dictamen_4", "Institucional_Local": "dictamen_4",

  "Institucional": "dictamen_5"
};
// --- CONFIGURACIÓN MAESTRA DE CELDAS POR DICTAMEN ---
// dónde se escribe cada dato para cada archivo específico.
const COORDENADAS_DICTAMENES = {
  
  // PARA FARMACIAS Y PRESTADORES (Solo Titular)
  "dictamen_1": {
    fecha: "I11",               // Fecha
    correlativo: "B11",         // RFV-2026...

    //solicitante: "B10",        // Nombre quien firma
    //cargo: "B11",              // Cargo quien firma

    tipoEstablecimiento: "D13",
    linkCarpeta: "D15", 

    nombreTitular: "C20",      // Nombre del profesional titular
    jvTitular: "J20"           // JVPM del titular
  },

  // PARA DROGUERÍAS, LABS Y TRS NACIONAL (Titular + Suplente)
  "dictamen_2": {
    fecha: "I11",
    correlativo: "B11",

    //solicitante: "B10",
    //cargo: "B11",

    tipoEstablecimiento: "D13",
    linkCarpeta: "D16", 

    nombreTitular: "C20",
    jvTitular: "J20",

    nombreSuplente: "C61",     // <--- Celda del Suplente
    jvSuplente: "J61"
  },

  // PARA TRS EXTRANJERO (Titular + Local)
  "dictamen_3": {
    
    fecha: "I11",               // Ejemplo: Quizás aquí la fecha está en otro lado
    correlativo: "B11",

    //solicitante: "A10",
    //cargo: "A11",
    tipoEstablecimiento: "D13",
    linkCarpeta: "D15",

    nombreTitular: "C20",      // Titular Internacional

    nombreSuplente: "C59",     // <--- Celda del Suplente
    jvSuplente: "J59",

    nombreLocal: "C109",        // <--- Celda del Referente Local
    jvLocal: "J109"


  },

  // PARA BOTIQUINES (Titular + ESAVI)
  "dictamen_4": {

    fecha: "I11",
    correlativo: "B11",

    //solicitante: "B10",
    //cargo: "B11",
    tipoEstablecimiento: "D13",
    linkCarpeta: "D16",

    nombreTitular: "C21",
    jvTitular: "J21",

    nombreSuplente: "C59",     // <--- Celda del Suplente
    jvSuplente: "J59",

    nombreEsavi: "C108",        // <--- Celda del ESAVI
    jvEsavi: "J108"
  },

  // PARA INSTITUCIONAL (Titular + Suplente + ESAVI)
  "dictamen_5": {

    fecha: "I11",
    correlativo: "B11",

    //solicitante: "B10",
    //cargo: "B11",

    tipoEstablecimiento: "D13",
    linkCarpeta: "D15",

    nombreTitular: "C20",
    jvTitular: "j20",

    nombreSuplente: "C59",
    jvSuplente: "j59",

    nombreEsavi: "C107",
    jvEsavi: "j107"
  }
};

function doGet() {
  return HtmlService.createTemplateFromFile('Index')
      .evaluate().setTitle('Gestión de Referentes - SRS')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function procesarFormulario(formObject) {
  // Logs para depuración
  console.log("Procesando solicitud...");
  
  const lock = LockService.getScriptLock();
  try { lock.waitLock(10000); } catch (e) { return "Error: Sistema saturado."; }

  let nuevoCorrelativo = "";
  
  // Generar ID solo para Nuevo Ingreso
  if (formObject.ni_tipoSolicitud) {
     nuevoCorrelativo = obtenerSiguienteCorrelativoMemoria(); 
  }
  
  lock.releaseLock(); 

  try {
    const ss = SpreadsheetApp.openById(ID_SHEET);

    // =========================================================
    // CASO 1: GESTIÓN REFERENTES (NUEVO INGRESO / CAMBIO)
    // =========================================================
    if (formObject.ni_tipoSolicitud) {
      const sheet = ss.getSheetByName("BITACORA DE RFV");
      
      // 1. Obtener carpeta RAÍZ > Carpeta AÑO
      const parentFolder = obtenerCarpetaDelAnio(ID_FOLDER_GESTION);
      
      // 2. Crear carpeta SOLICITUD
      const carpetaTramite = parentFolder.createFolder(nuevoCorrelativo);
      const urlCarpeta = carpetaTramite.getUrl();

       // --- LOGICA DE CORREOS ---
      const correoPrincipal = formObject.ni_email; 
      const todosLosCorreos = recopilarCorreos(formObject, 'ni'); 

      // A. Obtener nombre base del archivo
      const nombreArchivoBase = MAPA_DICTAMENES[formObject.ni_tipoEstablecimiento];

      // B. Copiar dictamen
      const idDictamenNuevo = copiarDictamen(formObject.ni_tipoEstablecimiento, carpetaTramite);

      // C. Llenar el dictamen
      if (idDictamenNuevo && nombreArchivoBase) {
         llenarDictamen(idDictamenNuevo, formObject, nuevoCorrelativo, nombreArchivoBase, urlCarpeta);
      } else {
         console.log("No se pudo llenar el dictamen: ID o Nombre base faltante.");
      }

      const urlFormulario = subirArchivo(formObject.file_ni_nombramiento, carpetaTramite, "NI_Formulario_" + nuevoCorrelativo);
      const titular = obtenerDatosRol(formObject, carpetaTramite, 'ni', 'titular');
      const suplente = obtenerDatosRol(formObject, carpetaTramite, 'ni', 'suplente');
      const esavi = obtenerDatosRol(formObject, carpetaTramite, 'ni', 'esavi');
      const local = obtenerDatosRol(formObject, carpetaTramite, 'ni', 'local');

      // --- PREPARAR LA FILA BASE (Datos comunes para todos los establecimientos) ---
      let filaBase = new Array(50).fill(""); // Aumenté a 50 para seguridad de índices

      filaBase[0] = nuevoCorrelativo;              // A
      filaBase[1] = urlCarpeta;                    // B
      filaBase[2] = formObject.ni_tipoSolicitud;   // C 
      filaBase[3] = formObject.ni_fecha;           // D

      // NOTA: Dejamos filaBase[6] vacía aquí, porque la llenaremos en el bucle abajo con el nombre específico

      filaBase[8] = formObject.ni_tipoEstablecimiento; // I
      filaBase[9] = formObject.ni_conglomerado || "N/A"; // J
      //filaBase[10] = formObject.ni_cantidadEstablecimientos || "N/A"; // K
      filaBase[14] = formObject.ni_nombreSolicitante || "N/A"; // O
      filaBase[15] = formObject.ni_cargoSolicitante || "N/A";  // P
      
      // Datos Referentes
      filaBase[16] = titular.nombre || "N/A";               
      filaBase[17] = titular.jv || "N/A";                   
      filaBase[18] = suplente.nombre || "N/A";              
      filaBase[19] = suplente.jv || "N/A";                  
      filaBase[20] = local.nombre || "N/A";                 
      filaBase[21] = local.jv || "N/A";                     
      filaBase[22] = esavi.nombre || "N/A";                 
      filaBase[23] = esavi.jv || "N/A";                     

      // Correo 
      filaBase[49] = correoPrincipal; 

      // =========================================================
      //  LÓGICA DE LISTA DE NOMBRES
      // =========================================================
      
      let listaNombres = [];
      
      // 1. Intentamos leer la lista JSON que viene del HTML
      try {
        if (formObject.ni_lista_nombres_final) {
           listaNombres = JSON.parse(formObject.ni_lista_nombres_final);
        }
      } catch (e) { console.log("Error leyendo lista nombres: " + e.message); }

      // 2. Seguridad: Si la lista está vacía, agregamos uno genérico para que se guarde al menos una fila
      if (listaNombres.length === 0) {
         // Si tenías un campo manual de respaldo, úsalo aquí, si no:
         listaNombres.push("NOMBRE NO ESPECIFICADO"); 
      }

      let bloqueDeFilas = [];

      filaBase[10] = listaNombres.length;

      // 3. Recorremos cada nombre y creamos su propia fila
      listaNombres.forEach(nombreEstab => {
          // Copiamos la fila base
          let filaIndividual = [...filaBase];
          
          // ASIGNAMOS EL NOMBRE EN LA COLUMNA G (Índice 10)
          // Asegúrate que en tu Excel la Columna G sea "Nombre Establecimiento"
          filaIndividual[12] = nombreEstab; 

          bloqueDeFilas.push(filaIndividual);
      });

      // --- GUARDADO MASIVO ---
      sheet.getRange(sheet.getLastRow() + 1, 1, bloqueDeFilas.length, filaBase.length).setValues(bloqueDeFilas);

      // *** ENVIO CON ADJUNTO ***
      enviarCorreoConfirmacion(
          todosLosCorreos, 
          "Nuevo Ingreso", 
          nuevoCorrelativo, 
          formObject.ni_nombreSolicitante, 
          formObject.file_ni_nombramiento 
      );

      return "Exito|" + nuevoCorrelativo;
    }

    // =========================================================
    // CASO 2: SUBSANACIÓN
    // =========================================================
    else if (formObject.sub_correlativo) {
      const sheet = ss.getSheetByName("BITACORA DE RFV");
      const codigoInput = formObject.sub_correlativo.trim().toUpperCase(); // Ej: RFV-2026-0005
      
      // 1. BUSCAR LA CARPETA ORIGINAL
      const carpetaExpediente = buscarCarpetaExpediente(codigoInput);
      
      if (!carpetaExpediente) {
        return "Error: No se encontró ningún expediente con el código " + codigoInput + ". Verifique que esté bien escrito, de la siguiente manera RFV-2026-XXXX.";
      }

      // 2. VALIDAR SI YA EXISTE SUBSANACIÓN (Para evitar duplicados)
      const subCarpetas = carpetaExpediente.getFoldersByName("Subsanación");
      if (subCarpetas.hasNext()) {
        return "Error: Este expediente (" + codigoInput + ") ya tiene una subsanación registrada. No se permite enviar más de una vez.";
      }

      // 3. CREAR LA SUBCARPETA DE SUBSANACIÓN DENTRO DE LA ORIGINAL
      const carpetaSubsanacion = carpetaExpediente.createFolder("Subsanación");
      
      // 4. SUBIR ARCHIVOS A ESA NUEVA SUBCARPETA
      const urlDocs = subirArchivo(formObject.file_sub_documentos, carpetaSubsanacion, "SUB_" + codigoInput);

      const correoPrincipal = formObject.sub_email;
      const todosLosCorreos = recopilarCorreos(formObject, 'sub');

      // 5. GUARDAR EN SHEET
      let fila = new Array(20).fill("");
      fila[0] = codigoInput;          // A
      fila[1] = carpetaSubsanacion.getUrl(); // B (Link directo a la subcarpeta)
	fila[2] ='Subsanación de observaciones'; 
      fila[3] = formObject.sub_fecha; 
      fila[8] = formObject.sub_tipoEstablecimiento; 
      fila[14] = formObject.sub_nombreSolicitante;   
      fila[15] = formObject.sub_cargoSolicitante;    
      fila[49] = correoPrincipal; 

      sheet.getRange(sheet.getLastRow() + 1, 1, 1, fila.length).setValues([fila]);
      
      // 6. ENVIAR CORREO
      

      // *** ENVIO CON ADJUNTO ***
      // Pasamos el archivo de subsanación
      enviarCorreoConfirmacion(
          todosLosCorreos, 
          "Subsanación", 
          codigoInput, 
          formObject.sub_nombreSolicitante,
          formObject.file_sub_documentos // <--- AQUÍ VA EL ARCHIVO
      );

      return "Exito|Subsanación registrada correctamente en el expediente: " + codigoInput;
    }

    // =========================================================
    // CASO 3: ATESTADOS
    // =========================================================
    else if (formObject.at_correlativo) {
      const sheet = ss.getSheetByName("BITACORA DE ATESTADOS");
      const codigoInput = formObject.at_correlativo.trim().toUpperCase();

      // 1. BUSCAR LA CARPETA ORIGINAL
      const carpetaExpediente = buscarCarpetaExpediente(codigoInput);
      
      if (!carpetaExpediente) {
        return "Error: No se encontró ningún expediente con el código " + codigoInput + ". Verifique que esté bien escrito, de la siguiente manera RFV-2026-XXXX";
      }

      // 2. CREAR SUBCARPETA "EVALUACIÓN DE ATESTADOS" 
      let carpetaEvaluacion;
      const checkFolder = carpetaExpediente.getFoldersByName("Evaluación de Atestados");
      if (checkFolder.hasNext()) {
         carpetaEvaluacion = checkFolder.next(); // Ya existía, usamos la misma
      } else {
         carpetaEvaluacion = carpetaExpediente.createFolder("Evaluación de Atestados");
      }

      // 3. SUBIR ARCHIVOS
      const urlDocs = subirArchivo(formObject.file_at_atestados,carpetaEvaluacion, "EVAL_" + codigoInput);

      const urlFormulario = subirArchivo(formObject.file_at_formulario, carpetaEvaluacion, "EVAL_Formulario_" + codigoInput);

      const correoPrincipal = formObject.at_email;
      const todosLosCorreos = recopilarCorreos(formObject, 'at');

      let fila = new Array(20).fill("");
      fila[0] = codigoInput;        
      fila[1] = carpetaEvaluacion.getUrl(); // Link a la subcarpeta
	fila[2] ='SOLICITUD DE EVALUACION DE ATESTADOS'; 
      fila[4] = formObject.at_fecha;
      fila[5] = formObject.at_tipoEstablecimiento; 
      fila[15] = correoPrincipal; 

      sheet.getRange(sheet.getLastRow() + 1, 1, 1, fila.length).setValues([fila]);
      

      // *** ENVIO CON ADJUNTO ***
      // Pasamos el FORMULARIO de evaluación (el nuevo)
      enviarCorreoConfirmacion(
          todosLosCorreos, 
          "Evaluación Atestados", 
          codigoInput, 
          "Usuario",
          formObject.file_at_formulario // <--- AQUÍ VA EL ARCHIVO
      );

      return "Exito|Evaluación agregada al expediente: " + codigoInput;
    }

  } catch (e) {
    return "Error: " + e.toString();
  }
}

// =========================================================
//  FUNCIONES AUXILIARES
// =========================================================

function obtenerCarpetaDelAnio(idCarpetaRaiz) {
  const rootFolder = DriveApp.getFolderById(idCarpetaRaiz);
  const currentYear = new Date().getFullYear().toString(); 
  const folders = rootFolder.getFoldersByName(currentYear);
  
  if (folders.hasNext()) {
    return folders.next(); 
  } else {
    return rootFolder.createFolder(currentYear); 
  }
}

// =========================================================
//  FUNCIÓN DE ENVÍO DE CORREOS (CON ADJUNTO)
// =========================================================
function enviarCorreoConfirmacion(emailDestino, tipoTramite, correlativo, nombre, archivoAdjunto) {
  if (!emailDestino) return;

  let asunto = "";
  let cuerpo = "";
  const estilo = 'font-family: Arial, sans-serif; color: #333; line-height: 1.5;';
  const estiloCodigo = 'font-size: 18px; font-weight: bold; color: #003366; background: #e6f0ff; padding: 10px; display: inline-block; border-radius: 5px;';

  if (tipoTramite === "Nuevo Ingreso") {
    asunto = "✅ Confirmación SRS - " + correlativo;
    cuerpo = `
      <div style="${estilo}">
        <h3>Estimado/a ${nombre || ''},</h3>
        <p>Su solicitud de <strong>Nombramiento de referentes</strong> ha sido registrada exitosamente.</p>
        <p>Número de solicitud generado:</p>
        <p><span style="${estiloCodigo}">${correlativo}</span></p>
        <p>Adjunto encontrará una copia de su formulario de solicitud.</p>
        <hr><small>Mensaje automático SRS.</small>
      </div>`;
  } else {
    asunto = "✅ Documentos Recibidos - " + correlativo;
    cuerpo = `
      <div style="${estilo}">
        <h3>Estimado Usuario,</h3>
        <p>Hemos recibido documentación para el trámite de <strong>${tipoTramite}</strong> asociado a la solicitud:</p>
        <p><span style="${estiloCodigo}">${correlativo}</span></p>
        <p>Adjunto encontrará una copia del documento enviado como respaldo.</p>
        <hr><small>Mensaje automático SRS.</small>
      </div>`;
  }

  // Configuración del correo
  const opcionesCorreo = {
    to: emailDestino,
    subject: asunto,
    htmlBody: cuerpo
  };

  // Si hay archivo, lo agregamos
  if (archivoAdjunto) {
    // Le ponemos el nombre del correlativo al archivo para que se vea profesional
    archivoAdjunto.setName(correlativo + ".pdf");
    opcionesCorreo.attachments = [archivoAdjunto];
  }

  try {
    MailApp.sendEmail(opcionesCorreo);
  } catch (e) {
    console.log("Error enviando correo: " + e.message);
  }
}

function obtenerSiguienteCorrelativoMemoria() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const year = new Date().getFullYear();
  const key = 'CONTADOR_' + year; 
  let ultimoNumero = Number(scriptProperties.getProperty(key) || 0);
  let nuevoNumero = ultimoNumero + 1;
  scriptProperties.setProperty(key, nuevoNumero.toString());
  return `RFV-${year}-${String(nuevoNumero).padStart(4, '0')}`;
}

function copiarDictamen(tipoEstablecimiento, carpetaDestino) {
  try {
    const nombreArchivo = MAPA_DICTAMENES[tipoEstablecimiento];
    if (!nombreArchivo) return null;

    const carpetaFuente = DriveApp.getFolderById(ID_FOLDER_DICTAMENES);
    const archivos = carpetaFuente.getFilesByName(nombreArchivo);
    
    if (archivos.hasNext()) {
      const archivoOriginal = archivos.next();
      // Copiar
      const archivoCopia = archivoOriginal.makeCopy("Dictamen_Para_Llenar", carpetaDestino);
      
      // ¡ESTA LÍNEA ES VITAL! Sin ella, no podemos llenar el archivo
      return archivoCopia.getId(); 
    }
  } catch (e) { 
    console.log("Error copiando dictamen: " + e.message); 
    return null;
  }
}

function subirArchivo(blob, folder, nombreBase) {
  if (!blob || typeof blob.getContentType !== 'function') return ""; 
  const bytes = blob.getBytes();
  if (bytes.length === 0) return "";
  
  const mimeType = blob.getContentType();
  if (mimeType !== 'application/pdf' && mimeType !== 'application/octet-stream') console.log("Warn: " + mimeType);

  try {
    const safeName = nombreBase.replace(/[^a-zA-Z0-9-_]/g, '_');
    blob.setName(safeName + ".pdf");
    return folder.createFile(blob).getUrl();
  } catch (e) { 
    throw new Error("Error interno subiendo archivo (" + nombreBase + "): " + e.message);
  }
}

function obtenerDatosRol(form, folder, prefix, rol) {
  const nombre = form[`${prefix}_nombre_${rol}`];
  // Si no hay nombre, devolvemos vacio.
  // Nota: En 'Cambio de Referente', los inputs no chequeados están disabled 
  // y no envían valor, así que esta línea los filtra correctamente.
  if (!nombre || nombre === "") {
      return { nombre: "", jv: "", urlAtest: "", urlAnual: "", urlCarnet: "", urlCarta: "" };
  }
  
  const jv = form[`${prefix}_jv_${rol}`] || "N/A"; 

  const urlAtest = subirArchivo(form[`${prefix}_file_${rol}_atestados`], folder, `${prefix}_${rol}_Atestados`);
  const urlAnual = subirArchivo(form[`${prefix}_file_${rol}_anualidad`], folder, `${prefix}_${rol}_Anualidad`);
  const urlCarnet = subirArchivo(form[`${prefix}_file_${rol}_carnet`], folder, `${prefix}_${rol}_Carnet`);
  const urlCarta = subirArchivo(form[`${prefix}_file_${rol}_carta`], folder, `${prefix}_${rol}_Carta`);
  
  // Archivo Respaldo (Extranjero)
  const urlRespaldo = subirArchivo(form[`${prefix}_file_${rol}_respaldo`], folder, `${prefix}_${rol}_Respaldo_Profesional`);

  // Si hay respaldo, lo ponemos en la variable del carnet para que se guarde en esa columna
  let carnetFinal = urlCarnet;
  if (urlRespaldo !== "") {
      carnetFinal = urlRespaldo + " (Doc. Respaldo)";
  }

  return {
    nombre: nombre,
    jv: jv,
    urlAtest: urlAtest,
    urlAnual: urlAnual,
    urlCarnet: carnetFinal, 
    urlCarta: urlCarta
  };
}

// llena los dictamenes de acuerdo al tipo de establecimiento
function llenarDictamen(idArchivo, formObject, correlativo, nombreArchivoBase, urlCarpeta) {
  try {
    const ss = SpreadsheetApp.openById(idArchivo);
    const hoja = ss.getSheets()[0]; 

    const mapa = COORDENADAS_DICTAMENES[nombreArchivoBase];
    if (!mapa) return;

    // --- FUNCIÓN HELPER PARA EVITAR ERRORES ---
    // Convierte a mayúsculas si existe texto, si no, devuelve vacío ""
    const safeUpper = (texto) => (texto ? String(texto).toUpperCase() : "");

    // 1. DATOS GENERALES
    if (mapa.fecha)       hoja.getRange(mapa.fecha).setValue(formObject.ni_fecha);
    if (mapa.correlativo) hoja.getRange(mapa.correlativo).setValue(correlativo);
    
    // Aquí solía fallar si ni_nombreSolicitante era undefined
    if (mapa.solicitante) hoja.getRange(mapa.solicitante).setValue(safeUpper(formObject.ni_nombreSolicitante));
    if (mapa.cargo)       hoja.getRange(mapa.cargo).setValue(safeUpper(formObject.ni_cargoSolicitante));

    // 2. DATOS NUEVOS (Link y Tipo)
    if (mapa.tipoEstablecimiento) hoja.getRange(mapa.tipoEstablecimiento).setValue(safeUpper(formObject.ni_tipoEstablecimiento));
    if (mapa.linkCarpeta && urlCarpeta) hoja.getRange(mapa.linkCarpeta).setValue(urlCarpeta);

    // 3. REFERENTES (Titular)
    // Verificamos si existe la coordenada Y si existe el dato
    if (mapa.nombreTitular) {
        // Probamos con las dos posibles claves (por si acaso hubo error de dedo)
        const val = formObject.ni_nombre_titular || "";
        hoja.getRange(mapa.nombreTitular).setValue(safeUpper(val));
    }
    if (mapa.jvTitular) {
        const val = formObject.ni_jv_titular || "";
        hoja.getRange(mapa.jvTitular).setValue(val);
    }

    // 4. SUPLENTE
    if (mapa.nombreSuplente) {
        const val = formObject.ni_nombre_suplente || "";
        hoja.getRange(mapa.nombreSuplente).setValue(safeUpper(val));
    }
    if (mapa.jvSuplente) {
        const val = formObject.ni_jv_suplente || "";
        hoja.getRange(mapa.jvSuplente).setValue(val);
    }

    // 5. ESAVI
    if (mapa.nombreEsavi) {
        const val = formObject.ni_nombre_esavi || "";
        hoja.getRange(mapa.nombreEsavi).setValue(safeUpper(val));
    }
    if (mapa.jvEsavi) {
        const val = formObject.ni_jv_esavi || "";
        hoja.getRange(mapa.jvEsavi).setValue(val);
    }

    // 6. LOCAL
    if (mapa.nombreLocal) {
        const val = formObject.ni_nombre_local || "";
        hoja.getRange(mapa.nombreLocal).setValue(safeUpper(val));
    }
    if (mapa.jvLocal) {
        const val = formObject.ni_jv_local || "";
        hoja.getRange(mapa.jvLocal).setValue(val);
    }

    SpreadsheetApp.flush();

  } catch (e) {
    console.log("Error crítico llenando dictamen: " + e.message);
  }
}

// --- FUNCIÓN PARA BUSCAR LA CARPETA ORIGINAL DEL TRÁMITE ---
function buscarCarpetaExpediente(correlativo) {
  try {
    // 1. Desglosar el código (Ej: RFV-2026-0005)
    const partes = correlativo.split('-');
    if (partes.length < 2) return null; // Formato inválido
    
    const anio = partes[1]; // "2026"
    
    // 2. Ir a la carpeta Raíz de GESTIÓN
    const rootFolder = DriveApp.getFolderById(ID_FOLDER_GESTION);
    
    // 3. Buscar la carpeta del AÑO
    const carpetasAnio = rootFolder.getFoldersByName(anio);
    if (!carpetasAnio.hasNext()) return null; // No existe carpeta del año 2026
    
    const carpetaAnio = carpetasAnio.next();
    
    // 4. Buscar la carpeta del EXPEDIENTE dentro del año
    const carpetasExpediente = carpetaAnio.getFoldersByName(correlativo);
    
    if (carpetasExpediente.hasNext()) {
      return carpetasExpediente.next(); //  Devolvemos la carpeta.
    } else {
      return null; // No existe ese expediente
    }
  } catch (e) {
    console.log("Error buscando carpeta: " + e.message);
    return null;
  }
}

// =========================================================
//  FUNCIÓN AUXILIAR: RECOPILAR CORREOS (PRINCIPAL + EXTRAS)
// =========================================================
function recopilarCorreos(formObject, prefix) {
  let listaCorreos = [];
  
  // 1. Correo Principal (Ej: ni_email)
  const mainEmail = formObject[prefix + '_email'];
  if (mainEmail && mainEmail.trim() !== "") {
    listaCorreos.push(mainEmail.trim());
  }
  
  // 2. Correos Extra (Ej: ni_email_2, ni_email_3...)
  // El HTML permite hasta 3 extras (ids terminan en 2, 3 y 4)
  for (let i = 2; i <= 4; i++) {
    const key = prefix + '_email_' + i;
    const correoExtra = formObject[key];
    
    if (correoExtra && correoExtra.trim() !== "") {
      listaCorreos.push(correoExtra.trim());
    }
  }
  
  // Retorna un string unido por comas, listo para MailApp
  // Ej: "jefe@farmacia.com, asistente@farmacia.com"
  return listaCorreos.join(",");
}
